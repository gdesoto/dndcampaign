// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "sqlite"
}

enum UserSystemRole {
  USER
  SYSTEM_ADMIN
}

enum CampaignRole {
  OWNER
  COLLABORATOR
  VIEWER
}

enum CampaignInviteStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String?
  name         String
  systemRole   UserSystemRole @default(USER)
  isActive     Boolean    @default(true)
  lastLoginAt  DateTime?
  avatarUrl    String?
  deletedAt    DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  campaigns    Campaign[]
  campaignMemberships CampaignMember[] @relation("CampaignMemberUser")
  campaignMembershipInvitesSent CampaignMember[] @relation("CampaignMemberInviter")
  campaignInvitesSent CampaignInvite[] @relation("CampaignInviteInviter")
  campaignInvitesAccepted CampaignInvite[] @relation("CampaignInviteAccepter")
  campaignPublicAccessUpdates CampaignPublicAccess[]
  activityActions ActivityLog[] @relation("ActivityActor")
  documentVersions DocumentVersion[]
  playerCharacters PlayerCharacter[]
  adminAuditActions AdminAuditLog[] @relation("AdminAuditActor")
  calendarEventsCreated CampaignCalendarEvent[]
  encountersCreated CampaignEncounter[]
  encounterEventsCreated EncounterEvent[]
  encounterTemplatesCreated EncounterTemplate[]
  encounterStatBlocksCreated EncounterStatBlock[]
  dungeonsCreated CampaignDungeon[]
  dungeonSnapshotsCreated CampaignDungeonSnapshot[]

  @@index([email])
}

model ActivityLog {
  id         String    @id @default(uuid())
  actorUserId String?
  actorUser  User?     @relation("ActivityActor", fields: [actorUserId], references: [id], onDelete: SetNull)
  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  scope      String
  action     String
  targetType String?
  targetId   String?
  summary    String?
  metadata   Json?
  createdAt  DateTime  @default(now())

  @@index([createdAt])
  @@index([actorUserId, createdAt])
  @@index([campaignId, createdAt])
  @@index([scope, action, createdAt])
}

model AdminAuditLog {
  id         String   @id @default(uuid())
  actorUserId String
  actorUser  User     @relation("AdminAuditActor", fields: [actorUserId], references: [id], onDelete: Restrict)
  action     String
  targetType String
  targetId   String?
  summary    String?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([actorUserId, createdAt])
  @@index([targetType, createdAt])
  @@index([action, createdAt])
}

model Campaign {
  id            String   @id @default(uuid())
  ownerId       String
  owner         User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  name          String
  system        String   @default("D&D 5e")
  isArchived    Boolean  @default(false)
  dungeonMasterName String?
  description   String?
  currentStatus String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  sessions      Session[]
  glossary      GlossaryEntry[]
  quests        Quest[]
  milestones    Milestone[]
  documents     Document[]
  characters    CampaignCharacter[]
  summaryJobs   SummaryJob[]
  maps          CampaignMap[]
  members       CampaignMember[]
  invites       CampaignInvite[]
  publicAccess  CampaignPublicAccess?
  activityLogs  ActivityLog[]
  calendarConfig CampaignCalendarConfig?
  calendarEvents CampaignCalendarEvent[]
  sessionCalendarRanges SessionCalendarRange[]
  encounters    CampaignEncounter[]
  encounterTemplates EncounterTemplate[]
  encounterStatBlocks EncounterStatBlock[]
  dungeons      CampaignDungeon[]

  @@index([ownerId])
}

model CampaignPublicAccess {
  campaignId       String   @id
  campaign         Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  isEnabled        Boolean  @default(false)
  isListed         Boolean  @default(false)
  publicSlug       String   @unique
  showCharacters   Boolean  @default(false)
  showRecaps       Boolean  @default(false)
  showSessions     Boolean  @default(false)
  showGlossary     Boolean  @default(false)
  showQuests       Boolean  @default(false)
  showMilestones   Boolean  @default(false)
  showMaps         Boolean  @default(false)
  updatedByUserId  String
  updatedByUser    User     @relation(fields: [updatedByUserId], references: [id], onDelete: Restrict)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([isEnabled])
}

model CampaignMember {
  id              String       @id @default(uuid())
  campaignId      String
  campaign        Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  userId          String
  user            User         @relation("CampaignMemberUser", fields: [userId], references: [id], onDelete: Cascade)
  role            CampaignRole
  invitedByUserId String
  invitedByUser   User         @relation("CampaignMemberInviter", fields: [invitedByUserId], references: [id], onDelete: Restrict)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([campaignId, userId])
  @@index([userId])
  @@index([campaignId, role])
}

model CampaignInvite {
  id              String             @id @default(uuid())
  campaignId      String
  campaign        Campaign           @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  email           String
  role            CampaignRole
  tokenHash       String             @unique
  status          CampaignInviteStatus @default(PENDING)
  expiresAt       DateTime
  invitedByUserId String
  invitedByUser   User               @relation("CampaignInviteInviter", fields: [invitedByUserId], references: [id], onDelete: Restrict)
  acceptedByUserId String?
  acceptedByUser  User?              @relation("CampaignInviteAccepter", fields: [acceptedByUserId], references: [id], onDelete: SetNull)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([campaignId, status])
  @@index([email, status])
  @@index([expiresAt])
}

model Session {
  id            String   @id @default(uuid())
  campaignId    String
  campaign      Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  title         String
  sessionNumber Int?
  playedAt      DateTime?
  guestDungeonMasterName String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  glossaryLinks GlossarySessionLink[]
  recordings    Recording[]
  documents     Document[]
  recap         RecapRecording?
  summaryJobs   SummaryJob[]
  calendarRange SessionCalendarRange?
  encounters    CampaignEncounter[]

  @@index([campaignId])
  @@unique([id, campaignId])
}

model CampaignCalendarConfig {
  id                String   @id @default(uuid())
  campaignId         String   @unique
  campaign           Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  isEnabled          Boolean  @default(false)
  name               String
  startingYear       Int
  firstWeekdayIndex  Int
  currentYear        Int
  currentMonth       Int
  currentDay         Int
  weekdaysJson       Json
  monthsJson         Json
  moonsJson          Json
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([campaignId, isEnabled])
}

model SessionCalendarRange {
  id         String   @id @default(uuid())
  sessionId  String   @unique
  campaignId String
  session    Session  @relation(fields: [sessionId, campaignId], references: [id, campaignId], onDelete: Cascade)
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  startYear  Int
  startMonth Int
  startDay   Int
  endYear    Int
  endMonth   Int
  endDay     Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([campaignId])
  @@unique([sessionId, campaignId])
  @@index([campaignId, startYear, startMonth, startDay])
  @@index([campaignId, endYear, endMonth, endDay])
}

model CampaignCalendarEvent {
  id              String   @id @default(uuid())
  campaignId      String
  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  year            Int
  month           Int
  day             Int
  title           String
  description     String?
  createdByUserId String
  createdByUser   User     @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([campaignId, year, month, day])
  @@index([campaignId, createdAt])
  @@index([createdByUserId])
}

enum EncounterStatus {
  PLANNED
  ACTIVE
  PAUSED
  COMPLETED
  ABANDONED
}

enum CampaignDungeonStatus {
  DRAFT
  READY
  ARCHIVED
}

enum CampaignDungeonGridType {
  SQUARE
}

enum CampaignDungeonRoomState {
  UNSEEN
  EXPLORED
  CLEARED
  CONTESTED
}

enum CampaignDungeonLinkType {
  SESSION
  QUEST
  MILESTONE
  GLOSSARY
  ENCOUNTER
}

enum CampaignDungeonSnapshotType {
  AUTO
  MANUAL
  PRE_REGENERATE
}

enum EncounterType {
  COMBAT
  SOCIAL
  SKILL_CHALLENGE
  CHASE
  HAZARD
}

enum EncounterVisibility {
  DM_ONLY
  SHARED
}

enum EncounterSide {
  ALLY
  ENEMY
  NEUTRAL
}

enum EncounterSourceType {
  CAMPAIGN_CHARACTER
  PLAYER_CHARACTER
  GLOSSARY_ENTRY
  CUSTOM
}

enum ConditionTickTiming {
  TURN_START
  TURN_END
  ROUND_END
}

enum EncounterEventType {
  ENCOUNTER
  TURN
  HP
  CONDITION
  NOTE
  SYSTEM
}

model CampaignEncounter {
  id               String              @id @default(uuid())
  campaignId       String
  campaign         Campaign            @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  sessionId        String?
  session          Session?            @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  name             String
  type             EncounterType       @default(COMBAT)
  status           EncounterStatus     @default(PLANNED)
  visibility       EncounterVisibility @default(SHARED)
  notes            String?
  calendarYear     Int?
  calendarMonth    Int?
  calendarDay      Int?
  currentRound     Int                @default(1)
  currentTurnIndex Int                @default(0)
  createdByUserId  String
  createdByUser    User               @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  combatants       EncounterCombatant[]
  events           EncounterEvent[]

  @@index([campaignId, createdAt])
  @@index([campaignId, status, updatedAt])
  @@index([sessionId])
  @@index([createdByUserId])
}

model EncounterCombatant {
  id                 String              @id @default(uuid())
  encounterId        String
  encounter          CampaignEncounter   @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  name               String
  side               EncounterSide       @default(ENEMY)
  sourceType         EncounterSourceType @default(CUSTOM)
  sourceCampaignCharacterId String?
  sourcePlayerCharacterId String?
  sourceGlossaryEntryId String?
  sourceStatBlockId  String?
  initiative         Int?
  sortOrder          Int
  maxHp              Int?
  currentHp          Int?
  tempHp             Int                 @default(0)
  armorClass         Int?
  speed              Int?
  isConcentrating    Boolean             @default(false)
  deathSaveSuccesses Int                 @default(0)
  deathSaveFailures  Int                 @default(0)
  isDefeated         Boolean             @default(false)
  isHidden           Boolean             @default(false)
  notes              String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  conditions         EncounterCondition[]

  @@index([encounterId, sortOrder])
  @@index([encounterId, initiative])
  @@index([sourceStatBlockId])
  @@unique([encounterId, sortOrder])
}

model EncounterCondition {
  id               String            @id @default(uuid())
  combatantId      String
  combatant        EncounterCombatant @relation(fields: [combatantId], references: [id], onDelete: Cascade)
  name             String
  duration         Int?
  remaining        Int?
  tickTiming       ConditionTickTiming @default(TURN_END)
  source           String?
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([combatantId, createdAt])
}

model EncounterEvent {
  id              String            @id @default(uuid())
  encounterId     String
  encounter       CampaignEncounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  eventType       EncounterEventType
  summary         String
  payload         Json?
  createdByUserId String?
  createdByUser   User?             @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  createdAt       DateTime          @default(now())

  @@index([encounterId, createdAt])
  @@index([eventType, createdAt])
  @@index([createdByUserId])
}

model EncounterTemplate {
  id              String                     @id @default(uuid())
  campaignId      String
  campaign        Campaign                   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  name            String
  type            EncounterType              @default(COMBAT)
  notes           String?
  createdByUserId String
  createdByUser   User                       @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)
  createdAt       DateTime                   @default(now())
  updatedAt       DateTime                   @updatedAt
  combatants      EncounterTemplateCombatant[]

  @@index([campaignId, createdAt])
  @@index([createdByUserId])
}

model EncounterTemplateCombatant {
  id                String              @id @default(uuid())
  templateId        String
  template          EncounterTemplate   @relation(fields: [templateId], references: [id], onDelete: Cascade)
  name              String
  side              EncounterSide       @default(ENEMY)
  sourceType        EncounterSourceType @default(CUSTOM)
  sourceStatBlockId String?
  maxHp             Int?
  armorClass        Int?
  speed             Int?
  quantity          Int                 @default(1)
  sortOrder         Int
  notes             String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([templateId, sortOrder])
  @@unique([templateId, sortOrder])
}

model EncounterStatBlock {
  id              String    @id @default(uuid())
  campaignId      String
  campaign        Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  name            String
  challengeRating String?
  statBlockJson   Json
  notes           String?
  createdByUserId String
  createdByUser   User      @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([campaignId, createdAt])
  @@index([createdByUserId])
  @@unique([campaignId, name])
}

model CampaignDungeon {
  id               String                   @id @default(uuid())
  campaignId       String
  campaign         Campaign                 @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  name             String
  status           CampaignDungeonStatus    @default(DRAFT)
  theme            String
  seed             String
  gridType         CampaignDungeonGridType  @default(SQUARE)
  generatorVersion String
  configJson       Json
  mapJson          Json
  playerViewJson   Json?
  createdByUserId  String
  createdByUser    User                     @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  rooms            CampaignDungeonRoom[]
  links            CampaignDungeonLink[]
  snapshots        CampaignDungeonSnapshot[]

  @@index([campaignId, updatedAt])
  @@index([campaignId, status, updatedAt])
  @@index([createdByUserId])
}

model CampaignDungeonRoom {
  id          String                  @id @default(uuid())
  dungeonId   String
  dungeon     CampaignDungeon         @relation(fields: [dungeonId], references: [id], onDelete: Cascade)
  roomNumber  Int
  name        String
  description String?
  gmNotes     String?
  playerNotes String?
  readAloud   String?
  tagsJson    Json?
  boundsJson  Json?
  state       CampaignDungeonRoomState @default(UNSEEN)
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  links       CampaignDungeonLink[]

  @@index([dungeonId, roomNumber])
  @@unique([dungeonId, roomNumber])
}

model CampaignDungeonLink {
  id        String                 @id @default(uuid())
  dungeonId String
  dungeon   CampaignDungeon        @relation(fields: [dungeonId], references: [id], onDelete: Cascade)
  roomId    String?
  room      CampaignDungeonRoom?   @relation(fields: [roomId], references: [id], onDelete: SetNull)
  linkType  CampaignDungeonLinkType
  targetId  String
  createdAt DateTime               @default(now())

  @@index([dungeonId, createdAt])
  @@index([roomId])
  @@index([linkType, targetId])
}

model CampaignDungeonSnapshot {
  id               String                     @id @default(uuid())
  dungeonId        String
  dungeon          CampaignDungeon            @relation(fields: [dungeonId], references: [id], onDelete: Cascade)
  snapshotType     CampaignDungeonSnapshotType
  seed             String
  generatorVersion String
  configJson       Json
  mapJson          Json
  createdByUserId  String
  createdByUser    User                       @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)
  createdAt        DateTime                   @default(now())

  @@index([dungeonId, createdAt])
  @@index([createdByUserId])
}

enum GlossaryType {
  PC
  NPC
  ITEM
  LOCATION
}

model GlossaryEntry {
  id          String   @id @default(uuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  type        GlossaryType
  name        String
  aliases     String?
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sessions    GlossarySessionLink[]
  campaignCharacters CampaignCharacter[]
  sourceMapId String?
  sourceMapFeatureId String?
  sourceMap   CampaignMap? @relation("GlossaryEntrySourceMap", fields: [sourceMapId], references: [id], onDelete: SetNull)
  sourceMapFeature CampaignMapFeature? @relation("GlossaryEntrySourceFeature", fields: [sourceMapFeatureId], references: [id], onDelete: SetNull)
  mapLinks    CampaignMapGlossaryLink[]

  @@index([campaignId, type])
  @@index([sourceMapId])
  @@index([sourceMapFeatureId])
}

enum CampaignMapStatus {
  ACTIVE
  ARCHIVED
}

enum CampaignMapSourceType {
  AZGAAR_FULL_JSON
}

enum CampaignMapFileKind {
  FULL_JSON
  SVG
  GEOJSON_MARKERS
  GEOJSON_RIVERS
  GEOJSON_ROUTES
  GEOJSON_CELLS
}

enum CampaignMapFeatureType {
  STATE
  PROVINCE
  BURG
  MARKER
  RIVER
  ROUTE
  CELL
}

enum CampaignMapGlossaryLinkType {
  LINKED
  MERGED
}

model CampaignMap {
  id                String               @id @default(uuid())
  campaignId        String
  campaign          Campaign             @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  name              String
  slug              String
  isPrimary         Boolean              @default(false)
  status            CampaignMapStatus    @default(ACTIVE)
  sourceType        CampaignMapSourceType @default(AZGAAR_FULL_JSON)
  createdById       String
  rawManifestJson   Json?
  importVersion     Int                  @default(1)
  sourceFingerprint String
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  files             CampaignMapFile[]
  features          CampaignMapFeature[]
  glossaryLinks     CampaignMapGlossaryLink[]
  sourceGlossaryEntries GlossaryEntry[]  @relation("GlossaryEntrySourceMap")

  @@index([campaignId])
  @@index([campaignId, isPrimary])
  @@unique([campaignId, slug])
}

model CampaignMapFile {
  id              String             @id @default(uuid())
  campaignMapId   String
  campaignMap     CampaignMap        @relation(fields: [campaignMapId], references: [id], onDelete: Cascade)
  kind            CampaignMapFileKind
  storageProvider StorageProvider
  storageKey      String
  contentType     String
  sizeBytes       Int
  checksum        String?
  createdAt       DateTime           @default(now())

  @@index([campaignMapId])
  @@index([kind])
}

model CampaignMapFeature {
  id             String                @id @default(uuid())
  campaignMapId  String
  campaignMap    CampaignMap           @relation(fields: [campaignMapId], references: [id], onDelete: Cascade)
  externalId     String
  featureType    CampaignMapFeatureType
  name           String
  displayName    String
  normalizedName String
  description    String?
  geometryType   String
  geometryJson   Json
  propertiesJson Json?
  sourceRef      String
  isActive       Boolean               @default(true)
  removed        Boolean               @default(false)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  glossaryLinks  CampaignMapGlossaryLink[]
  sourceGlossaryEntries GlossaryEntry[] @relation("GlossaryEntrySourceFeature")

  @@index([campaignMapId])
  @@index([campaignMapId, featureType])
  @@index([campaignMapId, normalizedName])
  @@unique([campaignMapId, featureType, externalId])
}

model CampaignMapGlossaryLink {
  id             String                    @id @default(uuid())
  campaignMapId  String
  campaignMap    CampaignMap               @relation(fields: [campaignMapId], references: [id], onDelete: Cascade)
  mapFeatureId   String
  mapFeature     CampaignMapFeature        @relation(fields: [mapFeatureId], references: [id], onDelete: Cascade)
  glossaryEntryId String
  glossaryEntry  GlossaryEntry             @relation(fields: [glossaryEntryId], references: [id], onDelete: Cascade)
  linkType       CampaignMapGlossaryLinkType
  createdAt      DateTime                  @default(now())

  @@unique([mapFeatureId, glossaryEntryId])
  @@index([campaignMapId])
  @@index([glossaryEntryId])
}

model GlossarySessionLink {
  id             String        @id @default(uuid())
  glossaryEntryId String
  sessionId      String
  glossaryEntry  GlossaryEntry @relation(fields: [glossaryEntryId], references: [id], onDelete: Cascade)
  session        Session       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  createdAt      DateTime      @default(now())

  @@unique([glossaryEntryId, sessionId])
  @@index([sessionId])
}

enum QuestStatus {
  ACTIVE
  COMPLETED
  FAILED
  ON_HOLD
}

enum QuestType {
  MAIN
  SIDE
  PLAYER
}

enum StorageProvider {
  LOCAL
  S3
  GDRIVE
  DB
}

enum RecordingKind {
  AUDIO
  VIDEO
}

enum TranscriptionProvider {
  ELEVENLABS
}

enum TranscriptionStatus {
  SENDING
  SENT
  PROCESSING
  COMPLETED
  FAILED
}

enum TranscriptionArtifactFormat {
  TXT
  SRT
  DOCX
  PDF
  HTML
  SEGMENTED_JSON
}

model Artifact {
  id            String          @id @default(uuid())
  ownerId       String
  campaignId    String?
  provider      StorageProvider
  storageKey    String
  mimeType      String
  byteSize      Int
  checksumSha256 String?
  label         String?
  meta          String?
  createdAt     DateTime        @default(now())
  recordings    Recording[]     @relation("RecordingMedia")
  vttRecordings Recording[]     @relation("RecordingVtt")
  recapRecordings RecapRecording[]
  transcriptionArtifacts TranscriptionArtifact[]
  characterPortraits PlayerCharacter[] @relation("CharacterPortrait")

  @@index([ownerId])
  @@index([campaignId])
  @@unique([provider, storageKey])
}

model Recording {
  id              String       @id @default(uuid())
  sessionId       String
  session         Session      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  kind            RecordingKind
  filename        String
  mimeType        String
  byteSize        Int
  durationSeconds Int?
  artifactId      String
  artifact        Artifact     @relation("RecordingMedia", fields: [artifactId], references: [id], onDelete: Restrict)
  vttArtifactId   String?
  vttArtifact     Artifact?    @relation("RecordingVtt", fields: [vttArtifactId], references: [id], onDelete: SetNull)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  documents       Document[]
  transcriptionJobs TranscriptionJob[]

  @@index([sessionId])
  @@index([artifactId])
  @@index([vttArtifactId])
}

model TranscriptionJob {
  id               String                @id @default(uuid())
  recordingId      String
  recording        Recording             @relation(fields: [recordingId], references: [id], onDelete: Cascade)
  provider         TranscriptionProvider
  status           TranscriptionStatus
  requestId        String?
  externalJobId    String?              @unique
  modelId          String?
  languageCode     String?
  numSpeakers      Int?
  diarize          Boolean               @default(true)
  tagAudioEvents   Boolean               @default(false)
  requestedFormats String?
  keyterms         String?
  errorMessage     String?
  completedAt      DateTime?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  artifacts        TranscriptionArtifact[]

  @@index([recordingId])
  @@index([status])
}

model TranscriptionArtifact {
  id                 String                     @id @default(uuid())
  transcriptionJobId String
  transcriptionJob   TranscriptionJob           @relation(fields: [transcriptionJobId], references: [id], onDelete: Cascade)
  artifactId         String
  artifact           Artifact                   @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  format             TranscriptionArtifactFormat
  createdAt          DateTime                   @default(now())

  @@unique([transcriptionJobId, format])
  @@index([artifactId])
}

model RecapRecording {
  id              String       @id @default(uuid())
  sessionId       String       @unique
  session         Session      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  filename        String
  mimeType        String
  byteSize        Int
  durationSeconds Int?
  artifactId      String
  artifact        Artifact     @relation(fields: [artifactId], references: [id], onDelete: Restrict)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([sessionId])
  @@index([artifactId])
}

model Quest {
  id            String      @id @default(uuid())
  campaignId    String
  campaign      Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  title         String
  description   String?
  type          QuestType   @default(SIDE)
  status        QuestStatus @default(ACTIVE)
  progressNotes String?
  sortOrder     Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([campaignId])
}

model Milestone {
  id          String   @id @default(uuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  title       String
  description String?
  isComplete  Boolean  @default(false)
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([campaignId])
}

enum DocumentType {
  TRANSCRIPT
  SUMMARY
  NOTES
}

enum DocumentFormat {
  MARKDOWN
  PLAINTEXT
}

enum DocumentSource {
  USER_EDIT
  USER_IMPORT
  SYSTEM_AUTOSAVE
  ELEVENLABS_IMPORT
  N8N_IMPORT
}

enum SummaryJobStatus {
  QUEUED
  SENT
  PROCESSING
  READY_FOR_REVIEW
  APPLIED
  FAILED
}

enum SummaryJobMode {
  SYNC
  ASYNC
}

enum SummaryJobKind {
  SUMMARY_GENERATION
  SUGGESTION_GENERATION
}

enum SummarySuggestionEntityType {
  SESSION
  QUEST
  MILESTONE
  GLOSSARY
  PC
  NPC
  ITEM
  LOCATION
}

enum SummarySuggestionAction {
  CREATE
  UPDATE
  DISCARD
}

enum SummarySuggestionStatus {
  PENDING
  APPLIED
  DISCARDED
}

model Document {
  id               String          @id @default(uuid())
  campaignId       String
  campaign         Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  sessionId        String?
  session          Session?        @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  recordingId      String?
  recording        Recording?      @relation(fields: [recordingId], references: [id], onDelete: SetNull)
  type             DocumentType
  title            String
  currentVersionId String?       @unique
  currentVersion   DocumentVersion? @relation("CurrentVersion", fields: [currentVersionId], references: [id])
  versions         DocumentVersion[] @relation("DocumentVersions")
  summaryJobsAsTranscript SummaryJob[] @relation("SummaryJobTranscript")
  summaryJobsAsSummary   SummaryJob[] @relation("SummaryJobSummary")
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([campaignId])
  @@index([sessionId])
  @@index([recordingId])
  @@unique([sessionId, type])
}

model DocumentVersion {
  id             String         @id @default(uuid())
  documentId     String
  document       Document       @relation("DocumentVersions", fields: [documentId], references: [id], onDelete: Cascade)
  currentForDocument Document?  @relation("CurrentVersion")
  versionNumber  Int
  content        String
  format         DocumentFormat @default(MARKDOWN)
  source         DocumentSource @default(USER_EDIT)
  createdByUserId String?
  createdByUser  User?          @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  createdAt      DateTime       @default(now())

  @@unique([documentId, versionNumber])
  @@index([createdByUserId])
}

model SummaryJob {
  id               String          @id @default(uuid())
  campaignId       String
  sessionId        String
  documentId       String
  summaryDocumentId String?
  trackingId       String          @unique
  status           SummaryJobStatus
  mode             SummaryJobMode
  kind             SummaryJobKind  @default(SUMMARY_GENERATION)
  promptProfile    String?
  webhookUrl       String?
  requestHash      String?
  responseHash     String?
  errorMessage     String?
  meta             Json?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  campaign         Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  session          Session         @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  document         Document        @relation("SummaryJobTranscript", fields: [documentId], references: [id], onDelete: Cascade)
  summaryDocument  Document?       @relation("SummaryJobSummary", fields: [summaryDocumentId], references: [id], onDelete: SetNull)
  suggestions      SummarySuggestion[]

  @@index([campaignId])
  @@index([sessionId])
  @@index([documentId])
  @@index([status])
  @@index([kind])
  @@index([sessionId, kind, createdAt])
}

model SummarySuggestion {
  id            String                    @id @default(uuid())
  summaryJobId  String
  entityType    SummarySuggestionEntityType
  action        SummarySuggestionAction
  status        SummarySuggestionStatus   @default(PENDING)
  match         Json?
  payload       Json
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt

  summaryJob    SummaryJob                @relation(fields: [summaryJobId], references: [id], onDelete: Cascade)

  @@index([summaryJobId])
  @@index([status])
}

enum CharacterSourceProvider {
  MANUAL
  DND_BEYOND
}

enum CharacterCampaignStatus {
  ACTIVE
  INACTIVE
}

enum CharacterOverwriteMode {
  FULL
  SECTIONS
}

model PlayerCharacter {
  id                String   @id @default(uuid())
  ownerId           String
  owner             User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  name              String
  status            String?
  portraitUrl       String?
  portraitArtifactId String?
  portraitArtifact  Artifact? @relation("CharacterPortrait", fields: [portraitArtifactId], references: [id], onDelete: SetNull)
  sheetJson         Json
  summaryJson       Json
  sourceProvider    CharacterSourceProvider @default(MANUAL)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  campaignLinks     CampaignCharacter[]
  imports           CharacterImport[]
  importSettings    CharacterImportSettings?

  @@index([ownerId])
  @@index([name])
}

model CampaignCharacter {
  id          String   @id @default(uuid())
  campaignId  String
  characterId String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  character   PlayerCharacter @relation(fields: [characterId], references: [id], onDelete: Cascade)
  glossaryEntryId String?
  glossaryEntry GlossaryEntry? @relation(fields: [glossaryEntryId], references: [id], onDelete: SetNull)
  status      CharacterCampaignStatus @default(ACTIVE)
  roleLabel   String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([campaignId, characterId])
  @@index([campaignId, status])
  @@index([characterId])
  @@index([glossaryEntryId])
}

model CharacterImport {
  id             String   @id @default(uuid())
  characterId    String
  character      PlayerCharacter @relation(fields: [characterId], references: [id], onDelete: Cascade)
  provider       CharacterSourceProvider
  externalId     String?
  sourceUrl      String?
  rawJson        Json
  rawHash        String
  importedAt     DateTime @default(now())
  lastSyncedAt   DateTime?
  lastSyncStatus String?
  lastSyncMessage String?

  @@index([characterId])
  @@index([provider, externalId])
}

model CharacterImportSettings {
  characterId          String   @id
  character            PlayerCharacter @relation(fields: [characterId], references: [id], onDelete: Cascade)
  lockedSections       Json?
  defaultOverwriteMode CharacterOverwriteMode @default(SECTIONS)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}
