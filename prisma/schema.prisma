// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String?
  name         String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  campaigns    Campaign[]
  documentVersions DocumentVersion[]

  @@index([email])
}

model Campaign {
  id            String   @id @default(uuid())
  ownerId       String
  owner         User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  name          String
  system        String   @default("D&D 5e")
  description   String?
  currentStatus String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  sessions      Session[]
  glossary      GlossaryEntry[]
  quests        Quest[]
  milestones    Milestone[]
  documents     Document[]

  @@index([ownerId])
}

model Session {
  id            String   @id @default(uuid())
  campaignId    String
  campaign      Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  title         String
  sessionNumber Int?
  playedAt      DateTime?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  glossaryLinks GlossarySessionLink[]
  recordings    Recording[]
  documents     Document[]
  recap         RecapRecording?

  @@index([campaignId])
}

enum GlossaryType {
  PC
  NPC
  ITEM
  LOCATION
}

model GlossaryEntry {
  id          String   @id @default(uuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  type        GlossaryType
  name        String
  aliases     String?
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sessions    GlossarySessionLink[]

  @@index([campaignId, type])
}

model GlossarySessionLink {
  id             String        @id @default(uuid())
  glossaryEntryId String
  sessionId      String
  glossaryEntry  GlossaryEntry @relation(fields: [glossaryEntryId], references: [id], onDelete: Cascade)
  session        Session       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  createdAt      DateTime      @default(now())

  @@unique([glossaryEntryId, sessionId])
  @@index([sessionId])
}

enum QuestStatus {
  ACTIVE
  COMPLETED
  FAILED
  ON_HOLD
}

enum StorageProvider {
  LOCAL
  S3
  GDRIVE
  DB
}

enum RecordingKind {
  AUDIO
  VIDEO
}

model Artifact {
  id            String          @id @default(uuid())
  ownerId       String
  campaignId    String?
  provider      StorageProvider
  storageKey    String
  mimeType      String
  byteSize      Int
  checksumSha256 String?
  label         String?
  meta          String?
  createdAt     DateTime        @default(now())
  recordings    Recording[]     @relation("RecordingMedia")
  vttRecordings Recording[]     @relation("RecordingVtt")
  recapRecordings RecapRecording[]

  @@index([ownerId])
  @@index([campaignId])
  @@unique([provider, storageKey])
}

model Recording {
  id              String       @id @default(uuid())
  sessionId       String
  session         Session      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  kind            RecordingKind
  filename        String
  mimeType        String
  byteSize        Int
  durationSeconds Int?
  artifactId      String
  artifact        Artifact     @relation("RecordingMedia", fields: [artifactId], references: [id], onDelete: Restrict)
  vttArtifactId   String?
  vttArtifact     Artifact?    @relation("RecordingVtt", fields: [vttArtifactId], references: [id], onDelete: SetNull)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  documents       Document[]

  @@index([sessionId])
  @@index([artifactId])
  @@index([vttArtifactId])
}

model RecapRecording {
  id              String       @id @default(uuid())
  sessionId       String       @unique
  session         Session      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  filename        String
  mimeType        String
  byteSize        Int
  durationSeconds Int?
  artifactId      String
  artifact        Artifact     @relation(fields: [artifactId], references: [id], onDelete: Restrict)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([sessionId])
  @@index([artifactId])
}

model Quest {
  id            String      @id @default(uuid())
  campaignId    String
  campaign      Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  title         String
  description   String?
  status        QuestStatus @default(ACTIVE)
  progressNotes String?
  sortOrder     Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([campaignId])
}

model Milestone {
  id          String   @id @default(uuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  title       String
  description String?
  isComplete  Boolean  @default(false)
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([campaignId])
}

enum DocumentType {
  TRANSCRIPT
  SUMMARY
  NOTES
}

enum DocumentFormat {
  MARKDOWN
  PLAINTEXT
}

enum DocumentSource {
  USER_EDIT
  USER_IMPORT
  SYSTEM_AUTOSAVE
}

model Document {
  id               String          @id @default(uuid())
  campaignId       String
  campaign         Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  sessionId        String?
  session          Session?        @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  recordingId      String?
  recording        Recording?      @relation(fields: [recordingId], references: [id], onDelete: SetNull)
  type             DocumentType
  title            String
  currentVersionId String?       @unique
  currentVersion   DocumentVersion? @relation("CurrentVersion", fields: [currentVersionId], references: [id])
  versions         DocumentVersion[] @relation("DocumentVersions")
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([campaignId])
  @@index([sessionId])
  @@index([recordingId])
  @@unique([sessionId, type])
}

model DocumentVersion {
  id             String         @id @default(uuid())
  documentId     String
  document       Document       @relation("DocumentVersions", fields: [documentId], references: [id], onDelete: Cascade)
  currentForDocument Document?  @relation("CurrentVersion")
  versionNumber  Int
  content        String
  format         DocumentFormat @default(MARKDOWN)
  source         DocumentSource @default(USER_EDIT)
  createdByUserId String?
  createdByUser  User?          @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  createdAt      DateTime       @default(now())

  @@unique([documentId, versionNumber])
  @@index([createdByUserId])
}
