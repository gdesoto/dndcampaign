// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String?
  name         String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  campaigns    Campaign[]
  documentVersions DocumentVersion[]
  playerCharacters PlayerCharacter[]

  @@index([email])
}

model Campaign {
  id            String   @id @default(uuid())
  ownerId       String
  owner         User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  name          String
  system        String   @default("D&D 5e")
  description   String?
  currentStatus String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  sessions      Session[]
  glossary      GlossaryEntry[]
  quests        Quest[]
  milestones    Milestone[]
  documents     Document[]
  characters    CampaignCharacter[]

  @@index([ownerId])
}

model Session {
  id            String   @id @default(uuid())
  campaignId    String
  campaign      Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  title         String
  sessionNumber Int?
  playedAt      DateTime?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  glossaryLinks GlossarySessionLink[]
  recordings    Recording[]
  documents     Document[]
  recap         RecapRecording?

  @@index([campaignId])
}

enum GlossaryType {
  PC
  NPC
  ITEM
  LOCATION
}

model GlossaryEntry {
  id          String   @id @default(uuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  type        GlossaryType
  name        String
  aliases     String?
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sessions    GlossarySessionLink[]

  @@index([campaignId, type])
}

model GlossarySessionLink {
  id             String        @id @default(uuid())
  glossaryEntryId String
  sessionId      String
  glossaryEntry  GlossaryEntry @relation(fields: [glossaryEntryId], references: [id], onDelete: Cascade)
  session        Session       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  createdAt      DateTime      @default(now())

  @@unique([glossaryEntryId, sessionId])
  @@index([sessionId])
}

enum QuestStatus {
  ACTIVE
  COMPLETED
  FAILED
  ON_HOLD
}

enum StorageProvider {
  LOCAL
  S3
  GDRIVE
  DB
}

enum RecordingKind {
  AUDIO
  VIDEO
}

enum TranscriptionProvider {
  ELEVENLABS
}

enum TranscriptionStatus {
  SENDING
  SENT
  PROCESSING
  COMPLETED
  FAILED
}

enum TranscriptionArtifactFormat {
  TXT
  SRT
  DOCX
  PDF
  HTML
  SEGMENTED_JSON
}

model Artifact {
  id            String          @id @default(uuid())
  ownerId       String
  campaignId    String?
  provider      StorageProvider
  storageKey    String
  mimeType      String
  byteSize      Int
  checksumSha256 String?
  label         String?
  meta          String?
  createdAt     DateTime        @default(now())
  recordings    Recording[]     @relation("RecordingMedia")
  vttRecordings Recording[]     @relation("RecordingVtt")
  recapRecordings RecapRecording[]
  transcriptionArtifacts TranscriptionArtifact[]
  characterPortraits PlayerCharacter[] @relation("CharacterPortrait")

  @@index([ownerId])
  @@index([campaignId])
  @@unique([provider, storageKey])
}

model Recording {
  id              String       @id @default(uuid())
  sessionId       String
  session         Session      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  kind            RecordingKind
  filename        String
  mimeType        String
  byteSize        Int
  durationSeconds Int?
  artifactId      String
  artifact        Artifact     @relation("RecordingMedia", fields: [artifactId], references: [id], onDelete: Restrict)
  vttArtifactId   String?
  vttArtifact     Artifact?    @relation("RecordingVtt", fields: [vttArtifactId], references: [id], onDelete: SetNull)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  documents       Document[]
  transcriptionJobs TranscriptionJob[]

  @@index([sessionId])
  @@index([artifactId])
  @@index([vttArtifactId])
}

model TranscriptionJob {
  id               String                @id @default(uuid())
  recordingId      String
  recording        Recording             @relation(fields: [recordingId], references: [id], onDelete: Cascade)
  provider         TranscriptionProvider
  status           TranscriptionStatus
  requestId        String?
  externalJobId    String?              @unique
  modelId          String?
  languageCode     String?
  numSpeakers      Int?
  diarize          Boolean               @default(true)
  requestedFormats String?
  keyterms         String?
  errorMessage     String?
  completedAt      DateTime?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  artifacts        TranscriptionArtifact[]

  @@index([recordingId])
  @@index([status])
}

model TranscriptionArtifact {
  id                 String                     @id @default(uuid())
  transcriptionJobId String
  transcriptionJob   TranscriptionJob           @relation(fields: [transcriptionJobId], references: [id], onDelete: Cascade)
  artifactId         String
  artifact           Artifact                   @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  format             TranscriptionArtifactFormat
  createdAt          DateTime                   @default(now())

  @@unique([transcriptionJobId, format])
  @@index([artifactId])
}

model RecapRecording {
  id              String       @id @default(uuid())
  sessionId       String       @unique
  session         Session      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  filename        String
  mimeType        String
  byteSize        Int
  durationSeconds Int?
  artifactId      String
  artifact        Artifact     @relation(fields: [artifactId], references: [id], onDelete: Restrict)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([sessionId])
  @@index([artifactId])
}

model Quest {
  id            String      @id @default(uuid())
  campaignId    String
  campaign      Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  title         String
  description   String?
  status        QuestStatus @default(ACTIVE)
  progressNotes String?
  sortOrder     Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([campaignId])
}

model Milestone {
  id          String   @id @default(uuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  title       String
  description String?
  isComplete  Boolean  @default(false)
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([campaignId])
}

enum DocumentType {
  TRANSCRIPT
  SUMMARY
  NOTES
}

enum DocumentFormat {
  MARKDOWN
  PLAINTEXT
}

enum DocumentSource {
  USER_EDIT
  USER_IMPORT
  SYSTEM_AUTOSAVE
  ELEVENLABS_IMPORT
}

model Document {
  id               String          @id @default(uuid())
  campaignId       String
  campaign         Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  sessionId        String?
  session          Session?        @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  recordingId      String?
  recording        Recording?      @relation(fields: [recordingId], references: [id], onDelete: SetNull)
  type             DocumentType
  title            String
  currentVersionId String?       @unique
  currentVersion   DocumentVersion? @relation("CurrentVersion", fields: [currentVersionId], references: [id])
  versions         DocumentVersion[] @relation("DocumentVersions")
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([campaignId])
  @@index([sessionId])
  @@index([recordingId])
  @@unique([sessionId, type])
}

model DocumentVersion {
  id             String         @id @default(uuid())
  documentId     String
  document       Document       @relation("DocumentVersions", fields: [documentId], references: [id], onDelete: Cascade)
  currentForDocument Document?  @relation("CurrentVersion")
  versionNumber  Int
  content        String
  format         DocumentFormat @default(MARKDOWN)
  source         DocumentSource @default(USER_EDIT)
  createdByUserId String?
  createdByUser  User?          @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  createdAt      DateTime       @default(now())

  @@unique([documentId, versionNumber])
  @@index([createdByUserId])
}

enum CharacterSourceProvider {
  MANUAL
  DND_BEYOND
}

enum CharacterCampaignStatus {
  ACTIVE
  INACTIVE
}

enum CharacterOverwriteMode {
  FULL
  SECTIONS
}

model PlayerCharacter {
  id                String   @id @default(uuid())
  ownerId           String
  owner             User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  name              String
  status            String?
  portraitUrl       String?
  portraitArtifactId String?
  portraitArtifact  Artifact? @relation("CharacterPortrait", fields: [portraitArtifactId], references: [id], onDelete: SetNull)
  sheetJson         Json
  summaryJson       Json
  sourceProvider    CharacterSourceProvider @default(MANUAL)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  campaignLinks     CampaignCharacter[]
  imports           CharacterImport[]
  importSettings    CharacterImportSettings?

  @@index([ownerId])
  @@index([name])
}

model CampaignCharacter {
  id          String   @id @default(uuid())
  campaignId  String
  characterId String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  character   PlayerCharacter @relation(fields: [characterId], references: [id], onDelete: Cascade)
  status      CharacterCampaignStatus @default(ACTIVE)
  roleLabel   String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([campaignId, characterId])
  @@index([campaignId, status])
  @@index([characterId])
}

model CharacterImport {
  id             String   @id @default(uuid())
  characterId    String
  character      PlayerCharacter @relation(fields: [characterId], references: [id], onDelete: Cascade)
  provider       CharacterSourceProvider
  externalId     String?
  sourceUrl      String?
  rawJson        Json
  rawHash        String
  importedAt     DateTime @default(now())
  lastSyncedAt   DateTime?
  lastSyncStatus String?
  lastSyncMessage String?

  @@index([characterId])
  @@index([provider, externalId])
}

model CharacterImportSettings {
  characterId          String   @id
  character            PlayerCharacter @relation(fields: [characterId], references: [id], onDelete: Cascade)
  lockedSections       Json?
  defaultOverwriteMode CharacterOverwriteMode @default(SECTIONS)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}
